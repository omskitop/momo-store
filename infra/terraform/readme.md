# Создание кластера K8S
Развертывание кластера Kubernetes выполняется с помощью Terraform через CI/CD. Используются шаблоны джоб из репозитория [gitlab.org](https://gitlab.com/gitlab-org/gitlab/-/tree/master/lib/gitlab/ci/templates/Terraform). Джобы `deploy` или `terraform_apply`(для деплоя из веток, отличных от master) запускаются вручную. Состояние всех объектов Terraform хранится в S3.

### Зависимости
- **Terraform**: `version >= 1.5.7`
- **Yandex Cloud Provider**: `version >= 0.87.0`
- **Gitlab**: `16.11.10 <= version < 18.0`
- **kubectl**: `version = 1.29.0`

### Переменные Gitlab CI/CD:
`YC_KEY` - Статический ключ доступа для сервисного аккаунта Yandex Cloud. Сервисный аккаунт должен быть создан заранее в консоли Yandex Cloud и ему должны быть предоставлены права администратора для папки, где планируется развернуть кластер k8s. Ключ можно получить с помощью команды:

```bash
yc iam key create --service-account-name <name> --output key.json
```

`YC_CLOUD_ID` - идентификатор облака, где будет создан кластер.

`YC_FOLDER_ID` - идентификатор папки, где будет создан кластер.

`YC_BUCKET_KEY_ID` - идентификатор ключ доступа к S3 бакет где Terraform хранит состояние. Бакет должен быть создан через облачную консоль Yandex, и доступ должен быть предоставлен в учетную запись Сервиса.

`YC_BUCKET_ACCESS_KEY` - секретный ключ доступа для S3 бакета.

`CLUSTER_NAME` - имя кластера.

### Output
После успешного создания кластера выводятся следующие данные:

`Cluster_IP_Adress` - внешний ip-адрес кластера.

`Cluster_ID` - уникальный иидентификатор кластера.
 
`Cluster_Name` - имя кластера.

### Подключение к кластеру
После создания кластера для ручного деплоя необходимо выполнить следующую команду в вашем терминале для получения конфигурации кластера:
```bash
yc managed-kubernetes cluster get-credentials <cluster_name_or_id> --external
```
Далее, проверьте информацию о кластере:
```bash
kubectl cluster-info
```
### Удаление кластера
Для удаления кластера и всех зависимых ресурсов запустите вручную джобу `cleanup` в Gitlab CI/CD.